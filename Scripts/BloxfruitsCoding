repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer

local Player = game.Players.LocalPlayer
local HttpService = game:GetService("HttpService")

local UserKey = getgenv().Key or ""
if UserKey == "" then
    Player:Kick("You haven't entered the key!")
    return
end

local GIST_URL = "https://gist.githubusercontent.com/thieengw9990/6fb529ff8227c92a29ae4fc16915148d/raw/f53d0c7283e3620940afc099ece382b8b44330d7/U0Z5K8X2M1R9S4TQLHFW7CVDNB3J6PYU0Z5K8X2M1R9S4TQLHFW7CVDNB3J6PYU0Z5K8X2M1R9S4TQLHFW7CVDNB3J6PYU0Z5K8X2M1R9S4TQLHFW7CVDNB3J6PYU0Z5K8X2M1R9S4TQLHFW7CVDNB3J6PYU0Z5K8X2M1R9S4TQLHFW7CVDNB3J6PY"

local function dateToTimestamp(dateStr)
    -- Format: "YYYY-MM-DD" hoặc "YYYY-MM-DD HH:MM:SS"
    if not dateStr or dateStr == "" then return nil end
    
    local pattern1 = "(%d+)-(%d+)-(%d+) (%d+):(%d+):(%d+)"
    local pattern2 = "(%d+)-(%d+)-(%d+)"
    
    local year, month, day, hour, minute, second
    
    -- Thử pattern có giờ phút giây
    year, month, day, hour, minute, second = dateStr:match(pattern1)
    
    if not year then
        -- Thử pattern chỉ có ngày
        year, month, day = dateStr:match(pattern2)
        hour, minute, second = 23, 59, 59 -- Set cuối ngày
    end
    
    if year and month and day then
        return os.time({
            year = tonumber(year),
            month = tonumber(month),
            day = tonumber(day),
            hour = tonumber(hour) or 23,
            min = tonumber(minute) or 59,
            sec = tonumber(second) or 59
        })
    end
    
    return nil
end

local function getIP()
    local services = {"https://api.ipify.org", "https://icanhazip.com"}
    for _, url in ipairs(services) do
        local success, result = pcall(function()
            return game:HttpGet(url, true):gsub("%s+", ""):gsub("\n", "")
        end)
        if success and result and result ~= "" then
            return result
        end
    end
    return "Unknown"
end

local UserIP = getIP()

local function loadKeyData()
    local success, response = pcall(function()
        return game:HttpGet(GIST_URL, true)
    end)
    
    if not success or not response then
        warn("⚠️Unable to connect to the server key!")
        return nil
    end

    local success2, data = pcall(function()
        return HttpService:JSONDecode(response)
    end)
    
    if not success2 or not data then
        warn("⚠️Error")
        return nil
    end

    return data
end

local keyData = loadKeyData()

if not keyData or not keyData.keys or not keyData.keys[UserKey] then
    Player:Kick("Key does not exist or is incorrect")
    return
end

local keyInfo = keyData.keys[UserKey]

if keyInfo.status and keyInfo.status == "banned" then
    Player:Kick("Your key has been banned!")
    return
end

if keyInfo.expires_at or keyInfo.expires then
    local expiryDate = keyInfo.expires_at or keyInfo.expires
    local expiryTimestamp = dateToTimestamp(expiryDate)
    local currentTime = os.time()
    
    if expiryTimestamp then
        if currentTime > expiryTimestamp then
            local createdDate = keyInfo.created_at or "Unknown"
            Player:Kick(string.format(
                "The key has expired!\n"..
                "Date created: %s\n"..
                "Expiration date: %s\n"..
                "Please renew your subscription to continue using the service!",
                createdDate, expiryDate
            ))
            return
        end
        
        -- Tính số ngày còn lại và hiển thị
        local daysLeft = math.floor((expiryTimestamp - currentTime) / 86400)
        local hoursLeft = math.floor(((expiryTimestamp - currentTime) % 86400) / 3600)
        
        if daysLeft > 0 then
            print(string.format("Key has %d days and %d hours remaining for use.", daysLeft, hoursLeft))
        elseif hoursLeft > 0 then
            print(string.format("Key has %d hours remaining.", hoursLeft))
        else
            print("The key is about to expire!")
        end
    else
        warn("Unable to parse expiration date:", expiryDate)
    end
else
    print("")
end

if keyInfo.ip and keyInfo.ip ~= "" and keyInfo.ip ~= UserIP then
    Player:Kick(string.format(
        "The key has been saved to a different IP address.\n"..
        "Your IP: %s\n"..
        "Binded IP: %s",
        UserIP, keyInfo.ip
    ))
    return
end

if not keyInfo.ip or keyInfo.ip == "" then
    keyInfo.ip = UserIP
    
    -- Update lên Gist
    local updateData = {
        keys = {
            [UserKey] = {
                ip = UserIP,
                time_start = keyInfo.time_start or os.time(),
                created_at = keyInfo.created_at,
                expires_at = keyInfo.expires_at,
                status = keyInfo.status or "active",
                last_used = os.date("%Y-%m-%d %H:%M:%S")
            }
        }
    }
    
    local payload = HttpService:JSONEncode(updateData)
    pcall(function()
        if syn and syn.request then
            syn.request({
                Url = GIST_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = payload
            })
        else
            HttpService:PostAsync(GIST_URL, payload)
        end
    end)
end


if not keyInfo.time_start then
    keyInfo.time_start = os.time()
    
    local updateData = {
        keys = {
            [UserKey] = {
                ip = UserIP,
                time_start = keyInfo.time_start,
                created_at = keyInfo.created_at,
                expires_at = keyInfo.expires_at,
                status = "active",
                last_used = os.date("%Y-%m-%d %H:%M:%S")
            }
        }
    }
    
    local payload = HttpService:JSONEncode(updateData)
    pcall(function()
        if syn and syn.request then
            syn.request({
                Url = GIST_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = payload
            })
        end
    end)
end

print("✅Loading...")


loadstring(game:HttpGet("https://raw.githubusercontent.com/karedskibidi/ThieenHuB/refs/heads/main/Main%20Scripts/LXYCAO", true))()
